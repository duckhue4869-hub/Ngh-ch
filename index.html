<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesture Recognition - 1, 2, I Love You</title>
    <style>
      body {
        margin: 0;
        background-color: #1a1a1a;
        font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        color: white;
        overflow: hidden;
      }

      #loading {
        position: absolute;
        top: 20px;
        font-size: 18px;
        color: #00ffff;
        z-index: 20;
      }

      /* Container ch√≠nh cho video v√† canvas */
      .video-container {
        position: relative;
        width: 640px;
        height: 480px;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      /* Video ·∫©n, ch·ªâ d√πng ƒë·ªÉ l·∫•y d·ªØ li·ªáu */
      #input_video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1); /* L·∫≠t ng∆∞·ª£c video ƒë·ªÉ gi·ªëng g∆∞∆°ng */
        z-index: 1;
        opacity: 0.5; /* L√†m m·ªù video g·ªëc ƒëi m·ªôt ch√∫t */
      }

      /* Canvas ƒë·ªÉ v·∫Ω c√°c ƒëi·ªÉm kh·ªõp tay l√™n tr√™n video */
      #output_canvas {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 2;
        transform: scaleX(-1);
      }

      /* Khu v·ª±c hi·ªÉn th·ªã k·∫øt qu·∫£ to ƒë√πng */
      #result-display {
        margin-top: 30px;
        font-size: 80px;
        font-weight: 800;
        text-align: center;
        min-height: 120px; /* Gi·ªØ ch·ªó ƒë·ªÉ kh√¥ng b·ªã nh·∫£y layout */
        text-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
        transition: all 0.3s ease;
      }

      .instruction {
        margin-top: 10px;
        font-size: 14px;
        color: #aaa;
        font-style: italic;
      }
    </style>

    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="loading">ƒêang kh·ªüi ƒë·ªông AI, vui l√≤ng ƒë·ª£i...</div>

    <div class="video-container">
      <video id="input_video"></video>
      <canvas id="output_canvas" width="640" height="480"></canvas>
    </div>

    <div id="result-display">---</div>
    <p class="instruction">
      Gi∆° 1 ng√≥n (tr·ªè), 2 ng√≥n (V-sign), ho·∫∑c k√Ω hi·ªáu "I Love You"ü§ü
    </p>

    <script>
      const videoElement = document.getElementById("input_video");
      const canvasElement = document.getElementById("output_canvas");
      const canvasCtx = canvasElement.getContext("2d");
      const resultDisplay = document.getElementById("result-display");
      const loadingDiv = document.getElementById("loading");

      // H√†m ki·ªÉm tra m·ªôt ng√≥n tay c√≥ ƒëang gi∆° l√™n hay kh√¥ng
      // S·ª≠ d·ª•ng logic ƒë∆°n gi·∫£n: ƒë·∫ßu ng√≥n tay cao h∆°n kh·ªõp n·ªëi (tr·ª•c Y tr√™n m√†n h√¨nh nh·ªè h∆°n)
      function isFingerUp(
        landmarks,
        fingerTipIndex,
        fingerPipIndex,
        isThumb = false
      ) {
        // V·ªõi ng√≥n c√°i, logic h∆°i kh√°c m·ªôt ch√∫t do c√°ch n√≥ di chuy·ªÉn
        // ƒê√¢y l√† c√°ch ki·ªÉm tra ƒë∆°n gi·∫£n, hi·ªáu qu·∫£ nh·∫•t khi gi·ªØ tay th·∫≥ng ƒë·ª©ng
        if (isThumb) {
          // So s√°nh ƒë·∫ßu ng√≥n c√°i (4) v·ªõi kh·ªõp g·ªëc ng√≥n tr·ªè (5) theo tr·ª•c X ƒë·ªÉ xem n√≥ c√≥ m·ªü ra kh√¥ng
          // C·∫ßn ƒëi·ªÅu ch·ªânh t√πy tay tr√°i ph·∫£i, nh∆∞ng check Y ƒë∆°n gi·∫£n n√†y t·∫°m ·ªïn cho t∆∞ th·∫ø ƒë·ª©ng
          return landmarks[fingerTipIndex].y < landmarks[fingerPipIndex].y;
        }
        // C√°c ng√≥n c√≤n l·∫°i: ƒë·∫ßu ng√≥n (tip) ph·∫£i cao h∆°n kh·ªõp gi·ªØa (pip)
        return landmarks[fingerTipIndex].y < landmarks[fingerPipIndex].y;
      }

      function onResults(results) {
        // ·∫®n loading khi c√≥ k·∫øt qu·∫£ ƒë·∫ßu ti√™n
        loadingDiv.style.display = "none";

        // X√≥a canvas ƒë·ªÉ v·∫Ω frame m·ªõi
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // N·∫øu ph√°t hi·ªán c√≥ tay
        if (
          results.multiHandLandmarks &&
          results.multiHandLandmarks.length > 0
        ) {
          // Ch·ªâ l·∫•y b√†n tay ƒë·∫ßu ti√™n ph√°t hi·ªán ƒë∆∞·ª£c ƒë·ªÉ x·ª≠ l√Ω cho ƒë∆°n gi·∫£n
          const landmarks = results.multiHandLandmarks[0];

          // V·∫Ω c√°c kh·ªõp tay l√™n canvas ƒë·ªÉ d·ªÖ theo d√µi
          drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {
            color: "#00ff00",
            lineWidth: 3,
          });
          drawLandmarks(canvasCtx, landmarks, {
            color: "#ff0000",
            lineWidth: 1,
            radius: 3,
          });

          // --- LOGIC NH·∫¨N DI·ªÜN C·ª¨ CH·ªà ---

          // C√°c ch·ªâ s·ªë landmark ƒë·∫ßu ng√≥n tay: 4 (C√°i), 8 (Tr·ªè), 12 (Gi·ªØa), 16 (√Åp √∫t), 20 (√öt)
          // C√°c ch·ªâ s·ªë landmark kh·ªõp d∆∞·ªõi n√≥ ƒë·ªÉ so s√°nh: 3, 6, 10, 14, 18

          // 1. X√°c ƒë·ªãnh tr·∫°ng th√°i t·ª´ng ng√≥n (L√™n/Xu·ªëng)
          const thumbUp = isFingerUp(landmarks, 4, 3, true); // Ng√≥n C√°i
          const indexUp = isFingerUp(landmarks, 8, 6); // Ng√≥n Tr·ªè
          const middleUp = isFingerUp(landmarks, 12, 10); // Ng√≥n Gi·ªØa
          const ringUp = isFingerUp(landmarks, 16, 14); // Ng√≥n √Åp √öt
          const pinkyUp = isFingerUp(landmarks, 20, 18); // Ng√≥n √öt

          let message = "";
          let color = "white";

          // 2. Ki·ªÉm tra c√°c t·ªï h·ª£p (∆Øu ti√™n c√°c c·ª≠ ch·ªâ ph·ª©c t·∫°p tr∆∞·ªõc)

          // --- C·ª≠ ch·ªâ "I LOVE YOU" (ü§ü) ---
          // Y√™u c·∫ßu: C√°i L√äN, Tr·ªè L√äN, √öt L√äN. (Gi·ªØa v√† √Åp √∫t G·∫¨P)
          if (thumbUp && indexUp && pinkyUp && !middleUp && !ringUp) {
            message = "ü§ü I LOVE YOU ü§ü";
            color = "#ff69b4"; // M√†u h·ªìng
          }
          // --- C·ª≠ ch·ªâ "S·ªê 2" (V-sign ‚úåÔ∏è) ---
          // Y√™u c·∫ßu: Tr·ªè L√äN, Gi·ªØa L√äN. (C√°c ng√≥n kh√°c G·∫¨P)
          // C·∫ßn check ch·∫∑t ch·∫Ω ƒë·ªÉ tr√°nh nh·∫ßm v·ªõi I Love You
          else if (indexUp && middleUp && !ringUp && !pinkyUp && !thumbUp) {
            message = "2";
            color = "#00ffff"; // M√†u xanh cyan
          }
          // --- C·ª≠ ch·ªâ "S·ªê 1" (‚òùÔ∏è) ---
          // Y√™u c·∫ßu: Ch·ªâ ng√≥n Tr·ªè L√äN.
          else if (indexUp && !middleUp && !ringUp && !pinkyUp && !thumbUp) {
            message = "1";
            color = "#ffff00"; // M√†u v√†ng
          } else {
            // Kh√¥ng kh·ªõp c·ª≠ ch·ªâ n√†o ƒë√£ ƒë·ªãnh nghƒ©a
            message = "---";
          }

          // Hi·ªÉn th·ªã k·∫øt qu·∫£
          if (message !== "---") {
            resultDisplay.innerText = message;
            resultDisplay.style.color = color;
          }
        } else {
          // Kh√¥ng th·∫•y tay
          // resultDisplay.innerText = "üîç ƒêang t√¨m tay...";
          resultDisplay.style.color = "#aaa";
        }
        canvasCtx.restore();
      }

      // C·∫•u h√¨nh MediaPipe Hands
      const hands = new Hands({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
      });
      hands.setOptions({
        maxNumHands: 1, // Ch·ªâ c·∫ßn ph√°t hi·ªán 1 tay cho ·ª©ng d·ª•ng n√†y
        modelComplexity: 1,
        minDetectionConfidence: 0.6, // TƒÉng ƒë·ªô tin c·∫≠y l√™n ch√∫t cho ch√≠nh x√°c
        minTrackingConfidence: 0.5,
      });
      hands.onResults(onResults);

      // Kh·ªüi ƒë·ªông Camera
      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await hands.send({ image: videoElement });
        },
        width: 640,
        height: 480,
      });
      camera.start();
    </script>
  </body>
</html>
