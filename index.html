<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Romantic Gesture Control</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@500&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
        font-family: "Pacifico", cursive;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      /* Container ch√≠nh */
      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
        background: #000;
      }

      /* Video n·ªÅn (l√†m m·ªù v√† t√¥ng h·ªìng) */
      #input_video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transform: scaleX(-1);
        opacity: 0.6; /* L√†m m·ªù video th·ª±c t·∫ø ƒë·ªÉ n·ªÅn ·∫£o hi·ªán l√™n */
        filter: sepia(0.3) hue-rotate(300deg) saturate(1.5); /* B·ªô l·ªçc m√†u h·ªìng m·ªông m∆° */
      }

      /* L·ªõp ph·ªß m√†u h·ªìng gradient */
      #overlay-gradient {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(
          circle,
          rgba(255, 192, 203, 0.1) 0%,
          rgba(255, 105, 180, 0.4) 100%
        );
        pointer-events: none;
        z-index: 1;
      }

      /* Canvas v·∫Ω hi·ªáu ·ª©ng tim bay */
      #particle_canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 2;
        pointer-events: none;
      }

      /* Khu v·ª±c hi·ªÉn th·ªã ch·ªØ */
      #message-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 3;
        text-align: center;
        width: 100%;
        pointer-events: none;
      }

      .main-text {
        font-size: 6rem;
        color: #fff;
        text-shadow: 0 0 20px #ff0055, 0 0 40px #ff0055;
        transition: all 0.5s ease;
        opacity: 0;
        transform: scale(0.8);
      }

      .main-text.visible {
        opacity: 1;
        transform: scale(1);
      }

      /* Hi·ªáu ·ª©ng nh·ªãp tim cho ch·ªØ I Love You */
      .heartbeat {
        animation: heartbeat 1.2s infinite;
      }

      @keyframes heartbeat {
        0% {
          transform: scale(1);
        }
        14% {
          transform: scale(1.1);
        }
        28% {
          transform: scale(1);
        }
        42% {
          transform: scale(1.1);
        }
        70% {
          transform: scale(1);
        }
      }

      #loading {
        position: absolute;
        top: 20px;
        left: 20px;
        color: #ff69b4;
        font-family: "Quicksand", sans-serif;
        z-index: 10;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px 20px;
        border-radius: 20px;
      }
    </style>

    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="loading">Dang khoi tao phep mau... ‚ú®</div>

    <div id="container">
      <video id="input_video"></video>
      <div id="overlay-gradient"></div>
      <canvas id="particle_canvas"></canvas>

      <div id="message-box">
        <div id="text-display" class="main-text"></div>
      </div>
    </div>

    <script>
      const videoElement = document.getElementById("input_video");
      const particleCanvas = document.getElementById("particle_canvas");
      const pCtx = particleCanvas.getContext("2d");
      const textDisplay = document.getElementById("text-display");
      const loadingDiv = document.getElementById("loading");

      // Resize canvas theo m√†n h√¨nh
      function resizeCanvas() {
        particleCanvas.width = window.innerWidth;
        particleCanvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      // --- H·ªÜ TH·ªêNG H·∫†T (TIM BAY) ---
      let particles = [];
      const hearts = ["‚ù§Ô∏è", "üíñ", "üíï", "ü•∞", "üíó"];

      class Particle {
        constructor() {
          this.x = Math.random() * particleCanvas.width;
          this.y = particleCanvas.height + 20; // B·∫Øt ƒë·∫ßu t·ª´ d∆∞·ªõi m√†n h√¨nh
          this.size = Math.random() * 30 + 15;
          this.speedY = Math.random() * 3 + 2; // T·ªëc ƒë·ªô bay l√™n
          this.speedX = Math.random() * 2 - 1; // L·∫Øc l∆∞ tr√°i ph·∫£i
          this.opacity = 1;
          this.symbol = hearts[Math.floor(Math.random() * hearts.length)];
        }
        update() {
          this.y -= this.speedY;
          this.x += Math.sin(this.y * 0.01) * 2; // Hi·ªáu ·ª©ng l·∫Øc l∆∞
          this.opacity -= 0.005; // M·ªù d·∫ßn
        }
        draw() {
          pCtx.globalAlpha = this.opacity;
          pCtx.font = `${this.size}px Arial`;
          pCtx.fillText(this.symbol, this.x, this.y);
          pCtx.globalAlpha = 1;
        }
      }

      // --- LOGIC NH·∫¨N DI·ªÜN TAY ---
      function isFingerUp(landmarks, tipIdx, pipIdx, isThumb = false) {
        return isThumb
          ? landmarks[tipIdx].x < landmarks[pipIdx].x
          : landmarks[tipIdx].y < landmarks[pipIdx].y;
      }

      // ƒêi·ªÅu ch·ªânh logic ng√≥n c√°i cho tay tr√°i/ph·∫£i tr√™n m√†n h√¨nh g∆∞∆°ng
      function isThumbUp(landmarks, handedness) {
        // Logic ƒë∆°n gi·∫£n: Check ƒë·ªô m·ªü c·ªßa ng√≥n c√°i so v·ªõi kh·ªõp
        const tip = landmarks[4];
        const ip = landmarks[3];
        // Kho·∫£ng c√°ch Euclide ƒë·ªÉ xem ng√≥n c√°i c√≥ ƒëang du·ªói ra kh√¥ng
        const dist = Math.sqrt(
          Math.pow(tip.x - landmarks[5].x, 2) +
            Math.pow(tip.y - landmarks[5].y, 2)
        );
        return dist > 0.05; // Ng∆∞·ª°ng du·ªói ng√≥n c√°i
      }

      let isLoveGesture = false;

      function onResults(results) {
        loadingDiv.style.display = "none";
        pCtx.clearRect(0, 0, particleCanvas.width, particleCanvas.height);

        let gestureFound = false;

        if (
          results.multiHandLandmarks &&
          results.multiHandLandmarks.length > 0
        ) {
          const landmarks = results.multiHandLandmarks[0];

          // Check tr·∫°ng th√°i ng√≥n
          const indexUp = landmarks[8].y < landmarks[6].y;
          const middleUp = landmarks[12].y < landmarks[10].y;
          const ringUp = landmarks[16].y < landmarks[14].y;
          const pinkyUp = landmarks[20].y < landmarks[18].y;

          // Logic ng√≥n c√°i (t∆∞∆°ng ƒë·ªëi)
          const thumbUp = Math.abs(landmarks[4].x - landmarks[2].x) > 0.05;

          // --- LOGIC C·ª¨ CH·ªà ---

          // 1. I LOVE YOU (ü§ü: C√°i, Tr·ªè, √öt m·ªü; Gi·ªØa, √Åp √∫t g·∫≠p)
          if (thumbUp && indexUp && pinkyUp && !middleUp && !ringUp) {
            textDisplay.innerText = "I ‚ù§Ô∏è You";
            textDisplay.className = "main-text visible heartbeat";
            isLoveGesture = true;
            gestureFound = true;
          }
          // 2. S·ªê 2 (‚úåÔ∏è: Tr·ªè, Gi·ªØa m·ªü)
          else if (indexUp && middleUp && !ringUp && !pinkyUp) {
            textDisplay.innerText = "Together üíï";
            textDisplay.className = "main-text visible";
            isLoveGesture = false; // Kh√¥ng m∆∞a tim, ch·ªâ hi·ªán ch·ªØ
            gestureFound = true;
          }
          // 3. S·ªê 1 (‚òùÔ∏è: Tr·ªè m·ªü)
          else if (indexUp && !middleUp && !ringUp && !pinkyUp) {
            textDisplay.innerText = "Only You üíñ";
            textDisplay.className = "main-text visible";
            isLoveGesture = false;
            gestureFound = true;
          }
        }

        if (!gestureFound) {
          textDisplay.classList.remove("visible");
          isLoveGesture = false;
        }

        // --- X·ª¨ L√ù H·∫†T (TIM BAY) ---
        // N·∫øu ƒëang I Love You -> T·∫°o th√™m tim m·ªõi li√™n t·ª•c
        if (isLoveGesture) {
          for (let i = 0; i < 3; i++) particles.push(new Particle());
        }

        // V·∫Ω v√† c·∫≠p nh·∫≠t tim
        for (let i = 0; i < particles.length; i++) {
          particles[i].update();
          particles[i].draw();
          // X√≥a h·∫°t ƒë√£ bi·∫øn m·∫•t ho·∫∑c bay kh·ªèi m√†n h√¨nh
          if (particles[i].opacity <= 0 || particles[i].y < -50) {
            particles.splice(i, 1);
            i--;
          }
        }
      }

      const hands = new Hands({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
      });
      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.5,
      });
      hands.onResults(onResults);

      const camera = new Camera(videoElement, {
        onFrame: async () => {
          await hands.send({ image: videoElement });
        },
        width: 1280,
        height: 720,
      });
      camera.start();
    </script>
  </body>
</html>
